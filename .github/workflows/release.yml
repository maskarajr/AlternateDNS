name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v2.1.0, etc.
  workflow_dispatch:  # Allows manual triggering
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        type: string
        default: 'v1.0.0'

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: .exe
            artifact: AlternateDNS-windows-amd64.exe

    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git describe

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22.3'

      - name: Get version from tag
        id: version
        shell: bash
        run: |
          # Handle manual dispatch with input, or extract from tag
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          
          if [ -z "$VERSION" ]; then
            echo "ERROR: Failed to extract version"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get commit hash
        id: commit
        shell: bash
        run: |
          if ! COMMIT=$(git rev-parse --short HEAD 2>&1); then
            echo "ERROR: Failed to get commit hash: $COMMIT"
            exit 1
          fi
          if [ -z "$COMMIT" ]; then
            echo "WARNING: Commit hash is empty, using 'unknown'"
            COMMIT="unknown"
          fi
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "Commit: $COMMIT"

      - name: Get build date
        id: date
        shell: bash
        run: |
          if ! DATE=$(date -u +'%Y-%m-%d' 2>&1); then
            echo "ERROR: Failed to get build date: $DATE"
            exit 1
          fi
          if [ -z "$DATE" ]; then
            echo "WARNING: Build date is empty, using fallback"
            DATE=$(date +'%Y-%m-%d')
          fi
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Build Date: $DATE"

      - name: Set up MinGW (Windows only)
        if: matrix.os == 'windows-latest'
        uses: egor-tensin/setup-mingw@v2
        with:
          platform: x64
        continue-on-error: true

      - name: Verify MinGW pthread library
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          # Primary path where Chocolatey installs MinGW pthread library (after setup-mingw action)
          PTHREAD_PATH="/c/ProgramData/mingw64/mingw64/x86_64-w64-mingw32/lib/libpthread.dll.a"
          
          # Refresh PATH to include MinGW bin directory
          export PATH="/c/ProgramData/mingw64/mingw64/bin:$PATH"
          
          # Check if pthread library exists at primary location
          if [ -f "$PTHREAD_PATH" ]; then
            echo "✓ Found pthread library at: $PTHREAD_PATH"
            echo "pthread library verification successful"
            exit 0
          fi
          
          echo "pthread library not found at expected location: $PTHREAD_PATH"
          echo "Checking alternative locations..."
          
          # Fallback: check other common locations
          ALTERNATIVE_PATHS=(
            "/c/ProgramData/mingw64/mingw64/lib/libpthread.dll.a"
            "/c/ProgramData/chocolatey/lib/mingw/tools/install/mingw64/x86_64-w64-mingw32/lib/libpthread.dll.a"
            "/c/msys64/mingw64/x86_64-w64-mingw32/lib/libpthread.dll.a"
          )
          
          FOUND=false
          for alt_path in "${ALTERNATIVE_PATHS[@]}"; do
            if [ -f "$alt_path" ]; then
              echo "✓ Found pthread library at alternative location: $alt_path"
              FOUND=true
              break
            fi
          done
          
          if [ "$FOUND" = false ]; then
            echo "ERROR: Cannot locate libpthread.dll.a required for CGO builds"
            echo "This library is required by Fyne GUI framework for Windows builds"
            echo ""
            echo "Searched locations:"
            echo "  ✗ $PTHREAD_PATH (primary)"
            for alt_path in "${ALTERNATIVE_PATHS[@]}"; do
              echo "  ✗ $alt_path"
            done
            echo ""
            echo "Note: The setup-mingw action may have installed MinGW but the pthread library"
            echo "is missing. This is a known issue with some MinGW distributions."
            echo ""
            echo "Possible solutions:"
            echo "1. The egor-tensin/setup-mingw action may need updating"
            echo "2. Consider switching to msys2/setup-msys2 action"
            exit 1
          fi
          
          echo "pthread library verification successful"

      - name: Compile icon resource (Windows only)
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          if [ ! -f "icon.rc" ]; then
            echo "Warning: icon.rc not found, skipping icon compilation"
            exit 0
          fi
          
          if [ ! -f "icon.ico" ]; then
            echo "Warning: icon.ico not found, skipping icon compilation"
            exit 0
          fi
          
          echo "Compiling icon resource..."
          if ! windres -o icon.syso icon.rc 2>&1; then
            echo "Warning: Failed to compile icon resource (build will continue without icon)"
            rm -f icon.syso
          else
            if [ -f "icon.syso" ]; then
              echo "Icon resource compiled successfully"
            else
              echo "Warning: icon.syso was not created"
            fi
          fi

      - name: Build
        env:
          CGO_ENABLED: 1
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ steps.version.outputs.version }}
          GIT_COMMIT: ${{ steps.commit.outputs.commit }}
          BUILD_DATE: ${{ steps.date.outputs.date }}
        shell: bash
        run: |
          echo "Building AlternateDNS for ${{ matrix.goos }}/${{ matrix.goarch }}..."
          echo "Version: ${{ steps.version.outputs.version }}"
          echo "Commit: ${{ steps.commit.outputs.commit }}"
          echo "Build Date: ${{ steps.date.outputs.date }}"
          
          if ! go build -ldflags="-s -w -H windowsgui -X main.Version=${{ steps.version.outputs.version }} -X main.GitCommit=${{ steps.commit.outputs.commit }} -X main.BuildDate=${{ steps.date.outputs.date }}" -o AlternateDNS${{ matrix.ext }} 2>&1; then
            echo "ERROR: Build failed!"
            echo "Exit code: $?"
            exit 1
          fi
          
          if [ ! -f "AlternateDNS${{ matrix.ext }}" ]; then
            echo "ERROR: Build completed but executable not found!"
            exit 1
          fi
          
          echo "Build successful! File size:"
          ls -lh AlternateDNS${{ matrix.ext }}

      - name: Create release directory
        shell: bash
        run: |
          mkdir -p release
          
          if [ ! -f "AlternateDNS${{ matrix.ext }}" ]; then
            echo "ERROR: Executable not found: AlternateDNS${{ matrix.ext }}"
            exit 1
          fi
          
          if ! cp AlternateDNS${{ matrix.ext }} release/${{ matrix.artifact }}; then
            echo "ERROR: Failed to copy executable to release directory"
            exit 1
          fi
          
          if [ ! -f "release/${{ matrix.artifact }}" ]; then
            echo "ERROR: File copy verification failed"
            exit 1
          fi
          
          if [ -f "default_config.yaml" ]; then
            if cp default_config.yaml release/; then
              echo "Copied default_config.yaml to release directory"
            else
              echo "Warning: Failed to copy default_config.yaml"
            fi
          else
            echo "Info: default_config.yaml not found (will use embedded config)"
          fi
          
          echo "Release directory contents:"
          ls -lh release/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: release/${{ matrix.artifact }}
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        shell: bash
        run: |
          # Handle manual dispatch with input, or extract from tag
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            # Remove 'v' prefix if present
            VERSION=${VERSION#v}
          else
            VERSION=${GITHUB_REF#refs/tags/v}
          fi
          
          if [ -z "$VERSION" ]; then
            echo "ERROR: Failed to extract version"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Get build date
        id: date
        shell: bash
        run: |
          if ! DATE=$(date -u +'%Y-%m-%d' 2>&1); then
            echo "ERROR: Failed to get build date: $DATE"
            exit 1
          fi
          if [ -z "$DATE" ]; then
            echo "WARNING: Build date is empty, using fallback"
            DATE=$(date +'%Y-%m-%d')
          fi
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "Build Date: $DATE"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Verify artifacts downloaded
        run: |
          if [ ! -d "artifacts" ]; then
            echo "ERROR: Artifacts directory not found"
            exit 1
          fi
          
          ARTIFACT_COUNT=$(find artifacts -name "AlternateDNS-*" -type f 2>/dev/null | wc -l)
          if [ "$ARTIFACT_COUNT" -eq 0 ]; then
            echo "ERROR: No artifacts found in artifacts directory"
            exit 1
          fi
          
          echo "Found $ARTIFACT_COUNT artifact(s):"
          find artifacts -name "AlternateDNS-*" -type f -exec ls -lh {} \;

      - name: Prepare release files
        run: |
          mkdir -p release
          # Copy all binaries
          find artifacts -name "AlternateDNS-*" -type f -exec cp {} release/ \;
          # Copy config file if it exists
          if [ -f "default_config.yaml" ]; then
            cp default_config.yaml release/
          fi
          
          # Create archives for each platform
          cd release
          
          if [ ! -d "." ] || [ -z "$(ls -A AlternateDNS-* 2>/dev/null)" ]; then
            echo "ERROR: No binaries found in release directory"
            exit 1
          fi
          
          for file in AlternateDNS-*; do
            if [ -f "$file" ] && [[ "$file" != *.sha256 ]] && [[ "$file" != *.zip ]] && [[ "$file" != *.tar.gz ]]; then
              # Get platform name from filename
              PLATFORM=$(echo "$file" | sed 's/AlternateDNS-\(.*\)\.exe/\1/' | sed 's/AlternateDNS-\(.*\)/\1/')
              
              # Determine archive type based on platform
              if [[ "$file" == *.exe ]]; then
                # Windows: use zip
                ARCHIVE_NAME="AlternateDNS-${PLATFORM}.zip"
                echo "Creating archive: $ARCHIVE_NAME"
                
                if ! zip "$ARCHIVE_NAME" "$file"; then
                  echo "ERROR: Failed to create zip archive: $ARCHIVE_NAME"
                  exit 1
                fi
                
                if [ -f "default_config.yaml" ]; then
                  if ! zip -u "$ARCHIVE_NAME" default_config.yaml; then
                    echo "WARNING: Failed to add default_config.yaml to archive"
                  fi
                fi
                
                CHECKSUM_FILE="${ARCHIVE_NAME}.sha256"
              else
                # Linux/macOS: use tar.gz (for future use)
                ARCHIVE_NAME="AlternateDNS-${PLATFORM}.tar.gz"
                echo "Creating archive: $ARCHIVE_NAME"
                
                if [ -f "default_config.yaml" ]; then
                  if ! tar -czf "$ARCHIVE_NAME" "$file" default_config.yaml; then
                    echo "ERROR: Failed to create tar.gz archive: $ARCHIVE_NAME"
                    exit 1
                  fi
                else
                  if ! tar -czf "$ARCHIVE_NAME" "$file"; then
                    echo "ERROR: Failed to create tar.gz archive: $ARCHIVE_NAME"
                    exit 1
                  fi
                fi
                
                CHECKSUM_FILE="${ARCHIVE_NAME}.sha256"
              fi
              
              if [ ! -f "$ARCHIVE_NAME" ]; then
                echo "ERROR: Archive was not created: $ARCHIVE_NAME"
                exit 1
              fi
              
              # Create checksum for archive
              if [[ "$OSTYPE" == "darwin"* ]]; then
                if ! shasum -a 256 "$ARCHIVE_NAME" > "$CHECKSUM_FILE"; then
                  echo "ERROR: Failed to create checksum file"
                  exit 1
                fi
              else
                if ! sha256sum "$ARCHIVE_NAME" > "$CHECKSUM_FILE"; then
                  echo "ERROR: Failed to create checksum file"
                  exit 1
                fi
              fi
              
              # Remove individual binary (keep only archive)
              rm "$file"
              echo "Created: $ARCHIVE_NAME ($(du -h "$ARCHIVE_NAME" | cut -f1))"
            fi
          done
          
          echo "Final release files:"
          ls -lh
          
          if [ -z "$(ls -A *.zip *.tar.gz 2>/dev/null)" ]; then
            echo "ERROR: No archives were created!"
            exit 1
          fi
          
          # Clean up: remove config file since it's already in the archives
          if [ -f "default_config.yaml" ]; then
            rm default_config.yaml
            echo "Removed default_config.yaml (already included in archives)"
          fi

      - name: Generate release notes
        id: notes
        run: |
          VERSION=${{ steps.version.outputs.version }}
          RELEASE_DATE=${{ steps.date.outputs.date }}
          
          # Create release notes with title and date
          {
            echo "# v${VERSION} Stable Release"
            echo ""
            echo "**Release date:** ${RELEASE_DATE}"
            echo ""
            
            # Extract version section from CHANGELOG.md if available
            if [ -f "CHANGELOG.md" ]; then
              # Extract content between version header and next version header
              awk -v version="$VERSION" '
                BEGIN { in_section=0; found=0 }
                /^## \[/ {
                  if (in_section) exit
                  if ($0 ~ "\\[" version "\\]") {
                    in_section=1
                    found=1
                    next
                  }
                }
                in_section && /^## \[/ { exit }
                in_section { print }
                END { if (!found) print "See [CHANGELOG.md](CHANGELOG.md) for details." }
              ' CHANGELOG.md | sed 's/^## \[.*\] - .*$//' | sed '/^$/N;/^\n$/d'
            else
              echo "See [CHANGELOG.md](CHANGELOG.md) for details."
            fi
          } > release_notes.txt
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat release_notes.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "Generated release notes:"
          cat release_notes.txt

      - name: Verify release files before upload
        run: |
          if [ ! -d "release" ]; then
            echo "ERROR: Release directory not found"
            exit 1
          fi
          
          FILE_COUNT=$(find release -type f \( -name "*.zip" -o -name "*.tar.gz" -o -name "*.sha256" \) | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "ERROR: No release files found in release directory"
            exit 1
          fi
          
          echo "Release files to upload ($FILE_COUNT files):"
          find release -type f -exec ls -lh {} \;
          
          # Verify checksums exist for all archives
          for archive in release/*.zip release/*.tar.gz; do
            if [ -f "$archive" ]; then
              CHECKSUM="${archive}.sha256"
              if [ ! -f "$CHECKSUM" ]; then
                echo "WARNING: Missing checksum for $archive"
              fi
            fi
          done

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*.zip release/*.tar.gz release/*.sha256
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## Windows Builds
            
            This release includes Windows builds for the following architectures:
            - amd64 (x86_64)
            
            ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Verify release created
        run: |
          echo "Release v${{ steps.version.outputs.version }} created successfully!"
          echo "Check https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.version }}"

